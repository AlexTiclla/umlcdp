<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>UML CD Editor</title>
        <link rel="icon" type="image/svg+xml" href="favicon.svg" />
        <link rel="icon" type="image/png" href="favicon.png" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="css/styles.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.0/backbone-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.5.5/joint.min.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.5.5/joint.min.css"
        />
        <!-- AuthManager para autenticación -->
        <script src="js/auth-manager.js"></script>
    </head>
    <body class="bg-gray-100">
        <!-- Header de Autenticación -->
        <div id="authHeader" class="bg-indigo-600 text-white px-4 py-2 text-sm" style="display: none;">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span>👤</span>
                    <span id="userInfo">Usuario no autenticado</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="logoutBtn" class="text-indigo-200 hover:text-white transition-colors">
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>

        <div class="flex h-screen bg-white">
            <div
                class="w-80 bg-white shadow-lg py-8 border-r border-gray-200 flex flex-col"
            >
                <div class="flex items-center gap-3 mb-8 px-6">
                    <svg
                        class="w-7 h-7 text-indigo-600 flex-shrink-0"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <rect x="4" y="3" width="7" height="8" rx="1" />
                        <rect x="13" y="13" width="7" height="8" rx="1" />
                        <line x1="7.5" y1="11" x2="7.5" y2="13" />
                        <line x1="7.5" y1="13" x2="16.5" y2="13" />
                        <line x1="4" y1="6" x2="11" y2="6" />
                        <line x1="13" y1="16" x2="20" y2="16" />
                        <circle cx="7.5" cy="13" r="1" fill="currentColor" />
                    </svg>
                    <a
                        href="javascript:void(0)"
                        onclick="window.location.reload()"
                        class="text-sm font-bold leading-tight hover:opacity-80 transition-opacity cursor-pointer"
                    >
                        <span class="text-gray-400">UML</span>
                        <span class="block text-gray-900">CLASS DIAGRAM</span>
                        <span class="text-indigo-600">EDITOR</span>
                    </a>
                </div>
                
                <!-- Sección de Autenticación mejorada con dropdown de perfil -->
                <div id="authSection" class="px-6 mb-4">
                    <!-- Prompt de Login (solo visible cuando NO está autenticado) -->
                    <div id="loginPrompt" class="bg-gray-50 rounded-lg p-4 text-center flex flex-col items-center gap-2">
                        <p class="text-sm text-gray-600 mb-2 w-full text-left">Inicia sesión para colaborar</p>
                        <a href="src/login.html" class="w-full">
                            <button class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-800 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2">
                                Iniciar Sesión
                            </button>
                        </a>
                    </div>
                    
                    <!-- Información del Usuario con Dropdown (solo visible cuando ESTÁ autenticado) -->
                    <div id="userInfo" class="relative" style="display: none;">
                        <!-- Header del Usuario -->
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-4 text-white shadow-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-sm" id="userName">Usuario</p>
                                        <p class="text-xs text-indigo-100" id="userRole">Colaborador</p>
                                    </div>
                                </div>
                                <button id="profileDropdownBtn" class="p-1 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors">
                                    <svg class="w-5 h-5 text-white transform transition-transform" id="dropdownIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Dropdown Menu -->
                        <div id="profileDropdown" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-200 z-50 overflow-hidden" style="display: none;">
                            <div class="py-2">
                                <button id="viewProfileBtn" class="w-full px-4 py-3 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition-colors">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Ver Perfil
                                </button>
                                <button id="editProfileBtn" class="w-full px-4 py-3 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition-colors">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    Editar Perfil
                                </button>
                                <button id="settingsBtn" class="w-full px-4 py-3 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition-colors">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Configuración
                                </button>
                                <hr class="my-2 border-gray-200">
                                <button id="logoutBtn" class="w-full px-4 py-3 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-3 transition-colors">
                                    <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Cerrar Sesión
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto px-6">
                    <div class="tool-section elements">
                        <h3>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"
                                ></rect>
                                <line x1="3" y1="9" x2="21" y2="9"></line>
                            </svg>
                            Elements
                        </h3>
                        <div class="space-y-2">
                            <button id="addClass" class="tool-btn">
                                <span>Class</span>
                            </button>
                            <button id="addInterface" class="tool-btn">
                                <span>Interface</span>
                            </button>
                            <button id="addAbstractClass" class="tool-btn">
                                <span>Abstract Class</span>
                            </button>
                        </div>
                    </div>
                    <div class="tool-section relationships">
                        <h3>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <path d="M3 6h18"></path>
                                <path d="M3 12h18"></path>
                                <path d="M3 18h18"></path>
                            </svg>
                            Relationships
                        </h3>
                        <div class="space-y-2">
                            <button id="addAssociation" class="tool-btn">
                                <span>Association</span>
                            </button>
                            <button
                                id="addNavigableAssociation"
                                class="tool-btn"
                            >
                                <span>Navigable Association</span>
                            </button>
                            <button id="addInheritance" class="tool-btn">
                                <span>Inheritance</span>
                            </button>
                            <button id="addImplementation" class="tool-btn">
                                <span>Implementation</span>
                            </button>
                            <button id="addComposition" class="tool-btn">
                                <span>Composition</span>
                            </button>
                            <button id="addAggregation" class="tool-btn">
                                <span>Aggregation</span>
                            </button>
                        </div>
                    </div>
                    <div class="tool-section code-generation">
                        <h3>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <polyline points="16 18 22 12 16 6"></polyline>
                                <polyline points="8 6 2 12 8 18"></polyline>
                            </svg>
                            Code Generation
                        </h3>
                        <div class="space-y-2">
                            <button id="codeGenButton" class="tool-btn">
                                <span>Generate Code</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="paper" class="flex-1 bg-white"></div>
        </div>
        <script src="js/umlShapes.js"></script>
        <script src="js/relationships.js"></script>
        <script src="js/codeGenerator.js"></script>
        <script src="js/api.js"></script>
        <script src="js/persistence.js"></script>
        <script src="js/main.js"></script>
        
        <!-- Script de Autenticación -->
        <script>
            // Inicializar autenticación cuando se carga la página
            document.addEventListener('DOMContentLoaded', function() {
                initializeAuthUI();
            });

            function initializeAuthUI() {
                const loginPrompt = document.getElementById('loginPrompt');
                const userInfo = document.getElementById('userInfo');
                const userName = document.getElementById('userName');
                const userRole = document.getElementById('userRole');
                const logoutBtn = document.getElementById('logoutBtn');
                const viewProfileBtn = document.getElementById('viewProfileBtn');
                const editProfileBtn = document.getElementById('editProfileBtn');
                const settingsBtn = document.getElementById('settingsBtn');
                const authHeader = document.getElementById('authHeader');
                const userInfoHeader = document.getElementById('userInfo');
                const profileDropdownBtn = document.getElementById('profileDropdownBtn');
                const profileDropdown = document.getElementById('profileDropdown');
                const dropdownIcon = document.getElementById('dropdownIcon');

                let isDropdownOpen = false;
                
                function toggleDropdown() {
                    isDropdownOpen = !isDropdownOpen;
                    profileDropdown.style.display = isDropdownOpen ? 'block' : 'none';
                    dropdownIcon.style.transform = isDropdownOpen ? 'rotate(180deg)' : 'rotate(0deg)';
                }

                // Cerrar dropdown al hacer click fuera
                document.addEventListener('click', function(event) {
                    if (!userInfo.contains(event.target) && isDropdownOpen) {
                        toggleDropdown();
                    }
                });

                // Configurar botón del dropdown
                if (profileDropdownBtn) {
                    profileDropdownBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleDropdown();
                    });
                }

                // Función para actualizar la UI de autenticación
                function updateAuthUI() {
                    // Verificar si el usuario está autenticado
                    if (window.authManager && window.authManager.isAuthenticated()) {
                        const currentUser = window.authManager.getCurrentUser();
                        
                        // Mostrar información del usuario
                        if (currentUser) {
                            userName.textContent = `${currentUser.first_name} ${currentUser.last_name}`;
                            userRole.textContent = currentUser.role || 'Colaborador';
                            userInfoHeader.textContent = `${currentUser.first_name} ${currentUser.last_name} (${currentUser.role})`;
                            
                            // Mostrar sección de usuario autenticado y ocultar login
                            loginPrompt.style.display = 'none';
                            userInfo.style.display = 'block';
                            authHeader.style.display = 'block';
                        }
                    } else {
                        // Ocultar información del usuario y mostrar prompt de login
                        loginPrompt.style.display = 'block';
                        userInfo.style.display = 'none';
                        authHeader.style.display = 'none';
                    }
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function() {
                        if (window.authManager) {
                            window.authManager.logout();
                            window.location.reload();
                        }
                    });
                }

                if (viewProfileBtn) {
                    viewProfileBtn.addEventListener('click', function() {
                        window.location.href = 'src/profile.html';
                    });
                }

                if (editProfileBtn) {
                    editProfileBtn.addEventListener('click', function() {
                        window.location.href = 'src/edit-profile.html';
                    });
                }

                if (settingsBtn) {
                    settingsBtn.addEventListener('click', function() {
                        window.location.href = 'src/settings.html';
                    });
                }

                // Escuchar cambios de autenticación
                window.addEventListener('authChange', function(e) {
                    if (e.detail.type === 'logout') {
                        updateAuthUI();
                    } else if (e.detail.type === 'login') {
                        updateAuthUI();
                    }
                });

                // Inicializar la UI
                updateAuthUI();
            }
        </script>
    </body>
</html>
